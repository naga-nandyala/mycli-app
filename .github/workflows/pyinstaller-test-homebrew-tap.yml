name: (pyinstaller) Test Homebrew Tap

on:
  # Test after releases (when binaries are updated)
  release:
    types: [published]
  
  # Allow manual testing
  workflow_dispatch:
    inputs:
      test_version:
        description: 'Version to test (leave empty for latest)'
        required: false
        type: string
  
  # Test on schedule (weekly)
  schedule:
    - cron: '0 10 * * 1'  # Every Monday at 10 AM UTC

jobs:
  test-homebrew-tap:
    name: Test Homebrew Tap Installation
    
    strategy:
      matrix:
        # Test on both Intel and Apple Silicon runners
        include:
          - runner: macos-latest
            arch: arm64
          - runner: macos-13  # Intel runner
            arch: x86_64
    
    runs-on: ${{ matrix.runner }}
    
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master
      
      - name: Get system info
        run: |
          echo "ğŸ–¥ï¸  System Information:"
          echo "Runner: ${{ matrix.runner }}"
          echo "Expected Architecture: ${{ matrix.arch }}"
          echo "Actual Architecture: $(uname -m)"
          echo "macOS Version: $(sw_vers -productVersion)"
          echo "Homebrew Version: $(brew --version | head -n1)"
      
      - name: Clean previous installations
        run: |
          echo "ğŸ§¹ Cleaning up any previous installations..."
          brew uninstall mycli-app 2>/dev/null || echo "No previous installation found"
          brew untap naga-nandyala/mycli-app 2>/dev/null || echo "No previous tap found"
      
      - name: Test Homebrew tap installation
        run: |
          echo "ğŸº Installing mycli-app via dedicated Homebrew tap..."
          
          echo "ğŸ“‹ Adding the homebrew tap..."
          brew tap naga-nandyala/mycli-app
          
          echo "ğŸ“‹ Verifying tap was added..."
          brew tap | grep naga-nandyala/mycli-app
          
          echo "ğŸº Installing mycli-app..."
          brew install mycli-app
      
      - name: Verify installation
        run: |
          echo "âœ… Verifying installation..."
          
          # Check if mycli is in PATH
          if ! command -v mycli &> /dev/null; then
            echo "âŒ mycli command not found in PATH"
            exit 1
          fi
          
          # Check version output
          echo "ğŸ“‹ Version check:"
          mycli_version=$(mycli --version)
          echo "Output: $mycli_version"
          
          # Verify it contains expected text
          if [[ "$mycli_version" =~ "MyCliApp version" ]]; then
            echo "âœ… Version check passed"
          else
            echo "âŒ Version check failed - unexpected output"
            exit 1
          fi
      
      - name: Test basic functionality
        run: |
          echo "ğŸ”§ Testing basic functionality..."
          
          # Test help command
          echo "ğŸ“‹ Help command test:"
          mycli --help
          
          # Test if binary architecture matches system
          echo "ğŸ—ï¸  Architecture verification:"
          binary_path=$(which mycli)
          echo "Binary location: $binary_path"
          
          if command -v file &> /dev/null; then
            file_output=$(file "$binary_path")
            echo "File output: $file_output"
            
            case "${{ matrix.arch }}" in
              "arm64")
                if [[ "$file_output" =~ "arm64" ]]; then
                  echo "âœ… ARM64 binary verification passed"
                else
                  echo "âš ï¸  Architecture mismatch detected but continuing..."
                fi
                ;;
              "x86_64")
                if [[ "$file_output" =~ "x86_64" ]]; then
                  echo "âœ… x86_64 binary verification passed"
                else
                  echo "âš ï¸  Architecture mismatch detected but continuing..."
                fi
                ;;
            esac
          fi
      
      - name: Test authentication functionality
        run: |
          echo "ğŸ” Testing authentication functionality..."
          
          # Test logout command
          echo "ğŸ“¤ Testing logout command:"
          mycli logout
          
          echo "âœ… Logout command completed successfully"
        
      - name: Test login with timeout
        timeout-minutes: 1
        run: |
          echo "ğŸ“¥ Testing login command with --force-broker:"
          
          # Run login command and capture output and exit code
          # In CI environment, we expect this to fail gracefully
          login_output=$(mycli login --force-broker 2>&1) || login_exit_code=$?
          echo "Login output: $login_output"
          echo "Login exit code: ${login_exit_code:-0}"
          
          # Check if the command attempted broker authentication
          if echo "$login_output" | grep -q "Broker-based authentication"; then
            echo "âœ… Broker authentication method was attempted"
            
            # Check if it failed due to CI environment (expected)
            if echo "$login_output" | grep -q "Force broker specified but only browser authentication is available\|Authorization type is not supported\|No accounts were found in the cache"; then
              echo "âœ… Expected broker authentication failure in CI environment"
              echo "âœ… This confirms broker detection is working correctly"
            elif echo "$login_output" | grep -q "Successfully authenticated"; then
              echo "âœ… Broker authentication succeeded (unexpected but good!)"
            else
              echo "âš ï¸  Unexpected broker authentication result, but continuing..."
            fi
          else
            echo "âŒ Broker authentication method was not attempted"
            echo "This indicates a potential issue with Azure SDK integration"
            exit 1
          fi
          
          echo "âœ… Force-broker login test completed successfully"
      - name: Test tap formula info
        run: |
          echo "ğŸ“Š Tap and formula information:"
          echo "ğŸ“‹ Tap info:"
          brew tap-info naga-nandyala/mycli-app
          
          echo "ğŸ“‹ Formula info:"
          brew info mycli-app
          
          echo "ğŸ“ Installation files:"
          brew list mycli-app
      
      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Final cleanup..."
          brew uninstall mycli-app 2>/dev/null || echo "Nothing to uninstall"
          brew untap naga-nandyala/mycli-app 2>/dev/null || echo "No tap to remove"
      
      - name: Report results
        if: always()
        run: |
          echo "ğŸ¯ Test Results Summary:"
          echo "Runner: ${{ matrix.runner }}"
          echo "Architecture: ${{ matrix.arch }}"
          echo "Status: ${{ job.status }}"
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… All tests passed!"
          else
            echo "âŒ Some tests failed"
          fi

  notify-results:
    name: Notify Test Results
    needs: test-homebrew-tap
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "ğŸ¯ Overall Test Results:"
          echo "Needed jobs status: ${{ needs.test-homebrew-tap.result }}"
          
          if [[ "${{ needs.test-homebrew-tap.result }}" == "success" ]]; then
            echo "âœ… All Homebrew tap tests passed successfully!"
            echo "ğŸº Tap installation is working correctly on all tested platforms"
          else
            echo "âŒ Some Homebrew tap tests failed"
            echo "ğŸ” Check the job logs for details"
            exit 1
          fi
